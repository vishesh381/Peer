<template>
    <lightning-card title="Staff Availability" icon-name="standard:shift">
        <div slot="actions">
            <lightning-button-icon
                icon-name="utility:refresh"
                alternative-text="Refresh"
                onclick={loadAvailability}>
            </lightning-button-icon>
        </div>

        <div class="slds-p-around_medium">
            <!-- Navigation -->
            <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-m-bottom_medium">
                <div class="slds-grid slds-grid_vertical-align-center">
                    <lightning-button-icon
                        icon-name="utility:chevronleft"
                        alternative-text="Previous Week"
                        onclick={handlePreviousWeek}
                        class="slds-m-right_x-small">
                    </lightning-button-icon>
                    <lightning-button
                        label="This Week"
                        onclick={handleThisWeek}
                        class="slds-m-right_x-small">
                    </lightning-button>
                    <lightning-button-icon
                        icon-name="utility:chevronright"
                        alternative-text="Next Week"
                        onclick={handleNextWeek}>
                    </lightning-button-icon>
                </div>
                <h2 class="slds-text-heading_small">{weekHeaderTitle}</h2>
            </div>

            <!-- Loading Spinner -->
            <template if:true={isLoading}>
                <div class="slds-is-relative" style="min-height: 200px;">
                    <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
                </div>
            </template>

            <!-- Week Grid -->
            <template if:false={isLoading}>
                <div class="availability-grid">
                    <template for:each={weekDates} for:item="day">
                        <div
                            key={day.dateStr}
                            class={day.dayClass}
                            data-date={day.dateStr}
                            onclick={handleDayClick}>

                            <div class="day-header">
                                <span class="day-name">{day.dayName}</span>
                                <span class="day-date">{day.month} {day.dayNumber}</span>
                            </div>

                            <div class="day-content">
                                <template if:true={day.availability.length}>
                                    <template for:each={day.availability} for:item="avail">
                                        <div key={avail.Id} class={avail.typeClass}>
                                            <div class="availability-item">
                                                <lightning-icon
                                                    icon-name={avail.typeIcon}
                                                    size="x-small"
                                                    class="slds-m-right_xx-small">
                                                </lightning-icon>
                                                <span class="availability-time">{avail.displayTime}</span>
                                                <span class="availability-type">{avail.Availability_Type__c}</span>
                                                <div class="availability-actions">
                                                    <lightning-button-icon
                                                        icon-name="utility:edit"
                                                        alternative-text="Edit"
                                                        size="x-small"
                                                        data-id={avail.Id}
                                                        onclick={handleEditAvailability}>
                                                    </lightning-button-icon>
                                                    <lightning-button-icon
                                                        icon-name="utility:delete"
                                                        alternative-text="Delete"
                                                        size="x-small"
                                                        data-id={avail.Id}
                                                        onclick={handleDeleteAvailability}>
                                                    </lightning-button-icon>
                                                </div>
                                            </div>
                                            <template if:true={avail.Notes__c}>
                                                <p class="availability-notes">{avail.Notes__c}</p>
                                            </template>
                                        </div>
                                    </template>
                                </template>
                                <template if:false={day.availability.length}>
                                    <div class="no-availability">
                                        <lightning-icon
                                            icon-name="utility:add"
                                            size="small"
                                            class="add-icon">
                                        </lightning-icon>
                                        <span>Click to add</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Legend -->
                <div class="legend slds-m-top_medium">
                    <span class="legend-item">
                        <span class="legend-color working"></span> Working Hours
                    </span>
                    <span class="legend-item">
                        <span class="legend-color pto"></span> PTO / Day Off
                    </span>
                    <span class="legend-item">
                        <span class="legend-color blocked"></span> Blocked Time
                    </span>
                </div>
            </template>
        </div>
    </lightning-card>

    <!-- Add/Edit Availability Modal -->
    <template if:true={showModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <lightning-button-icon
                        icon-name="utility:close"
                        alternative-text="Close"
                        class="slds-modal__close"
                        onclick={handleCloseModal}>
                    </lightning-button-icon>
                    <h2 class="slds-modal__title">{modalTitle}</h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium">
                    <div class="slds-grid slds-gutters slds-wrap">
                        <div class="slds-col slds-size_1-of-2">
                            <lightning-input
                                type="time"
                                label="Start Time"
                                value={formStartTime}
                                onchange={handleStartTimeChange}
                                required>
                            </lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-2">
                            <lightning-input
                                type="time"
                                label="End Time"
                                value={formEndTime}
                                onchange={handleEndTimeChange}
                                required>
                            </lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-m-top_small">
                            <lightning-radio-group
                                name="availabilityType"
                                label="Availability Type"
                                options={availabilityTypes}
                                value={formAvailabilityType}
                                onchange={handleTypeChange}
                                type="button">
                            </lightning-radio-group>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-m-top_small">
                            <lightning-textarea
                                label="Notes (optional)"
                                value={formNotes}
                                onchange={handleNotesChange}
                                max-length="255">
                            </lightning-textarea>
                        </div>
                    </div>
                </div>
                <footer class="slds-modal__footer">
                    <lightning-button
                        label="Cancel"
                        onclick={handleCloseModal}
                        class="slds-m-right_small">
                    </lightning-button>
                    <lightning-button
                        label="Save"
                        variant="brand"
                        onclick={handleSaveAvailability}>
                    </lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>